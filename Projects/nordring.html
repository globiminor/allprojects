<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css" />
    <!--<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" />

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>-->
    <script src="//api3.geo.admin.ch/loader.js?version=4.4.2"></script>
    <style>
        .map {
            width: auto;
            height: 900px;
        }

        tr.selected {
            background-color: lightgray;
        }

        tr.highlight {
            background-color: whitesmoke;
        }

        .legend {
            margin: 0;
            height: 12px;
        }

        .ltxt {
            height: 37px;
            vertical-align: text-top;
        }
    </style>
</head>
<body>

    <table>
        <tr>
            <td style="vertical-align:top">
                <h3>Legende</h3>
                <table>
                    <tr>
                        <td style="vertical-align:top">
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(255,0,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(255,64,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(255,128,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(255,192,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(255,255,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(192,255,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(128,255,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(64,255,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,255,0);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,255,64);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,255,128);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,255,192);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,255,255);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,192,255);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,128,255);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,64,255);" /></svg></div>
                            <div class="legend"><svg width="60" height="12"><rect width="60" height="12" style="fill:rgb(0,0,255);" /></svg></div>
                        </td>
                        <td style="vertical-align:top">
                            <div class="ltxt" style="margin-top:4px">0%</div>
                            <div class="ltxt">20%</div>
                            <div class="ltxt">40%</div>
                            <div class="ltxt">60%</div>
                            <div class="ltxt">80%</div>
                            <div class="ltxt">100%</div>
                        </td>
                    </tr>
                </table>
                <img id="idImgNordring" />
                <p>Nordring</p>
                <img id="idImgKatzenbach" width="75" height="75" />
                <p>Katzenbach</p>
                <button onclick="replay()">Replay</button>
            </td>
            <td width="100%">
                <div id="map" class="map" style="position:relative">
                    <pre id="idInfo" style="z-index: 1; opacity: 0; position: absolute; bottom: 0; left: 0; margin: 0;
                              background: rgba(0,60,136,0.7); color: white; border: 0; transition: opacity 100ms ease-in;"></pre>
                </div>
            </td>
        </tr>
    </table>

    <script>
        var textStyle = new ol.style.Text({
            font: 'bold 11px "Open Sans", "Arial Unicode MS", "sans-serif"',
            placement: 'point',
            fill: new ol.style.Fill({
                color: 'darkgrey'
            })
        });

        /**
* depth: 1 - monochrome
*        4 - 4-bit grayscale
*        8 - 8-bit grayscale
*       16 - 16-bit colour
*       32 - 32-bit colour
**/
        function getImgSrc(arr, depth, height, width) {
            var offset, data;

            function conv(size) {
                return String.fromCharCode(size & 0xff, (size >> 8) & 0xff, (size >> 16) & 0xff, (size >> 24) & 0xff);
            }

            offset = depth <= 8 ? 54 + Math.pow(2, depth) * 4 : 54;
            var pixelCount = arr.length * 8 / depth;

            // height = Math.ceil(Math.sqrt(pixelCount));
            // width = Math.floor(pixelCount / height);
            // alert('h,w:' + height + ';' + width);

            //BMP Header
            data = 'BM';                          // ID field
            data += conv(offset + arr.length);     // BMP size
            data += conv(0);                       // unused
            data += conv(offset);                  // pixel data offset

            //DIB Header
            data += conv(40);                      // DIB header length
            data += conv(height);                  // image height
            data += conv(width);                  // image width
            data += String.fromCharCode(1, 0);     // colour panes
            data += String.fromCharCode(depth, 0); // bits per pixel
            data += conv(0);                       // compression method
            data += conv(arr.length);              // size of the raw data
            data += conv(2835);                    // horizontal print resolution
            data += conv(2835);                    // vertical print resolution
            data += conv(0);                       // colour palette, 0 == 2^n
            data += conv(0);                       // important colours

            //Grayscale tables for bit depths <= 8
            if (depth <= 8) {
                data += conv(0);

                for (var s = Math.floor(255 / (Math.pow(2, depth) - 1)), i = s; i < 256; i += s) {
                    data += conv(i + i * 256 + i * 65536);
                }
            }

            //Pixel data
            data += String.fromCharCode.apply(String, arr);

            //Image element
            var src = 'data:image/bmp;base64,' + btoa(data);
            return src;
        }

        //function drawArray(arr, depth) {
        //    var src = getImgSrc(arr, depth);
        //    var image = document.createElement('img');
        //    image.src = src;
        //    return image;
        //}

        /*Usage example, visualize random numbers generated by Math.random */

        //for (var a = [], i = 0; i < 8192; i++) {
        //    a[i] = Math.floor(Math.random() * 256);
        //}

        //document.body.appendChild(drawArray(a, 1));
        //document.body.appendChild(drawArray(a, 4));
        //document.body.appendChild(drawArray(a, 8));
        //document.body.appendChild(drawArray(a, 16));
        //document.body.appendChild(drawArray(a, 32));
        function getImgFromLyr(lyr) {
            //var b = [
            //    31, 127, 0, 0,
            //    63, 63,
            //    63, 63,
            //    15, 15,
            //    31, 31,
            //];
            // var bytes = [];
            var features = lyr.getSource().getFeatures();
            var dim = features.length;
            var fill = Math.ceil(dim / 32) * 32;
            var keys = [];
            var dict = {};
            var isNumeric = false;
            for (var iFtr = 0; iFtr < dim; iFtr++) {
                var ftr = features[iFtr];
                var k = ftr.get('key');
                var s = ftr.get('starts');
                var b = 0;
                var bytes = [];
                for (var i = 0; i < dim; i++) {
                    b = b * 2;
                    var c1 = String.fromCharCode(65 + i);
                    var c2 = (i + 1).toString();
                    if (s.includes(c1) || s.includes(c2)) {
                        b = b + 1;
                    }
                    if (i % 8 == 7) {
                        bytes.push(255 - b);
                        b = 0;
                    }
                }
                for (var i = dim; i < fill; i++) {
                    b = b * 2;
                    if (i % 8 == 7) {
                        bytes.push(255 - b);
                        b = 0;
                    }
                }
                dict[k] = bytes;
                keys.push(k);
                isNumeric = !Number.isNaN(parseFloat(k));
            }
            if (isNumeric) {
                keys.sort(function (a, b) { return a - b });
            } else {
                keys.sort();
            }
            keys.reverse();
            var all = [];
            for (var iKey = 0; iKey < keys.length; iKey++) {
                var bytes = dict[keys[iKey]];
                for (var iByte = 0; iByte < bytes.length; iByte++) {
                    all.push(bytes[iByte]);
                }
            }

            return getImgSrc(all, 1, dim, dim);
        }

        function CalcCompleted(lyr) {
            var c = 0;
            var features = lyr.getSource().getFeatures();
            var nFeatures = features.length;
            for (var iFtr = 0; iFtr < nFeatures; iFtr++) {
                var ftr = features[iFtr];
                var s = ftr.get('starts');
                c += s.length;
            }
            lyr.set('completed', c);
        }

        function fillDict(lyr, startDict, endDict) {
            var features = lyr.getSource().getFeatures();
            var dim = features.length;
            var isNumeric = false;
            for (var iFtr = 0; iFtr < dim; iFtr++) {
                var ftr = features[iFtr];
                var k = ftr.get('key');
                var s = ftr.get('starts');
                startDict[k] = s;
                var e = ftr.get('ends');
                endDict[k] = e;
                isNumeric = !Number.isNaN(parseFloat(k));
            }
            return isNumeric;
        }

        function getCombs(comp, isNumeric) {
            var nComp = comp.length;

            var combs = [];

            for (iComp = nComp - 1; iComp >= 0; iComp--) {
                var p = comp[iComp];
                var nc = p.length;
                var iKey = 0;
                var keys = [];

                for (var iC = 10; iC < nc; iC++) {
                    var key = getKey(p, iC, isNumeric);
                    if (key == null) {
                        continue;
                    }
                    keys.push(key);
                    iKey++;
                    if (iKey == 2) {
                        var s = keys[0];
                        var e = keys[1];

                        combs.push([s, e]);

                        keys = [];
                        iKey = 0;
                    }
                }
            }
            return combs;
        }

        function addPlan(lyr, plan) {
            var invalid = "";

            var startDict = {};
            var endDict = {};
            var isNumeric = fillDict(lyr, startDict, endDict);

            var combs = getCombs(plan, isNumeric);
            var nCombs = combs.length;

            for (iComb = 0; iComb < nCombs; iComb++) {
                var comb = combs[iComb];
                var s = comb[0];
                var e = comb[1];
                var sd = startDict[s];
                if (!sd.includes(e.toString())) {
                    sd.push(e.toString());
                } else {
                    invalid += s + "->" + e + ";";
                }

                var ed = endDict[e];
                if (!ed.includes(s.toString())) {
                    ed.push(s.toString());
                }
            }
            if (invalid.length > 0) {
                alert("invalid: " + invalid);
            }
        }

        function getKey(p, iC, isNumeric) {
            if (isNumeric) {
                var n = parseInt(p[iC]);
                if (isNaN(n)) {
                    var code = p.charCodeAt(iC);
                    var a = "a".charCodeAt(0);
                    var g = "g".charCodeAt(0);
                    if (code >= a && code <= g) {
                        n = 10 + code - a;
                    }
                }
                if (isNaN(n)) {
                    return null;
                }
                return n;
            } else {
                var a = "A".charCodeAt(0);
                var y = "Y".charCodeAt(0);
                var code = p.charCodeAt(iC);
                if (code < a || code > y) {
                    return null;
                }
                return p[iC];
            }

        }

        function createLayer(kombs) {
            var features = [];
            var dict = {};
            var iKomb = 0;
            for (iKomb = 0; iKomb < kombs.length; iKomb++) {
                var komb = kombs[iKomb];

                var rep = komb.replace('  ', ' ');
                while (komb.length > rep.length) {
                    komb = rep;
                    rep = komb.replace('  ', ' ');
                }

                var parts = komb.split(' ');
                var x = parseFloat(parts[1]);
                if (Number.isNaN(x) || x < 2000000) {
                    continue;
                }
                dict[parts[0]] = parts;
            }

            var total = 0;
            var completed = 0;
            for (var key in dict) {
                var isNumber = !Number.isNaN(parseFloat(key));
                var parts = dict[key];

                var x = parseFloat(parts[1]);
                var y = parseFloat(parts[2]);
                var starts = [];
                var iPart = 0;
                for (iPart = 4; iPart < parts.length; iPart++) {
                    total++;
                    if (parts[iPart] != '-') {
                        completed++;
                        if (isNumber) {
                            starts.push((iPart - 3).toString());
                        } else {
                            starts.push(String.fromCharCode(61 + iPart));
                        }
                    }
                }
                var ends = [];
                var iEnd = isNumber
                    ? parseInt(key) + 3
                    : key.charCodeAt(0) - 61;
                for (var ek in dict) {
                    var ep = dict[ek];
                    if (ep[iEnd] != '-') {
                        ends.push(ek);
                    }
                }

                var feature = new ol.Feature({
                    geometry: new ol.geom.Point([x, y]),
                    key: key,
                    title: parts[3],
                    starts: starts,
                    ends: ends
                });
                features.push(feature);
            }

            var vectorSource = new ol.source.Vector({ features: features });
            var vectorLayer = new ol.layer.Vector({ source: vectorSource, total: total, completed: completed });

            var nKombs = kombs.length - 1;
            vectorLayer.setStyle(function (feature, resolution) {
                var starts = feature.get('starts');
                var ends = feature.get('ends');

                var fStart = (starts.length + 0.0) / nKombs;
                var fEnd = (ends.length + 0.0) / nKombs;
                var style = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        stroke: new ol.style.Stroke({
                            color: getColor(fStart),
                            width: 3
                        }),
                        fill: new ol.style.Fill({ color: getColor(fEnd) }),
                    }),
                    text: textStyle
                });
                style.getText().setText(feature.get('key'));
                return style;
            });
            return vectorLayer;
        }

        // Create a GeoAdmin Map
        var map = new ga.Map({

            // Define the div where the map is placed
            target: 'map',

            // Create a view
            view: new ol.View({

                // Define the default resolution
                // 10 means that one pixel is 10m width and height
                // List of resolution of the WMTS layers:
                // 650, 500, 250, 100, 50, 20, 10, 5, 2.5, 2, 1, 0.5, 0.25, 0.1
                resolution: 5,

                // Define a coordinate CH1903+ (EPSG:2056) for the center of the view
                center: [2682000, 1253000]
            })
        });


        //var nordringKombs = [
        //    '                                                 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16',
        //    '1  2684705.0 1253361.2 Thurgauerstrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
        //    '2  2684312.5 1253556.2 Schaffhauserstrasse       -   -   -   -   -   -   -   -   -   +   +   +   +   -   +   +',
        //    '3  2684115.0 1253703.7 Frohbühl                  -   -   -   -   -   -   -   -   -   +   +   +   +   -   +   +',
        //    '4  2683325.0 1254116.2 Waldegg                   -   -   -   -   -   -   -   -   -       +   +   +   -   +   +',
        //    '5  2683080.0 1254181.2 Guldenen                  -   -   -   -   -   -   -   -   -       +   +   +   -   +   +',
        //    '6  2682790.0 1254233.7 Altwi                     -   -   -   -   -   -   -   -   -       +   +   +   -   +   +',
        //    '7  2682370.0 1254246.2 Chäshalden                -   -   -   -   -   -   -   -   L       +   +   +   -   +   +',
        //    '8  2681305.0 1253971.3 Bärenbohl                 -   -   -   -   -   -   -   -   -       +   +   +   -   +   +',
        //    '9  2681020.0 1253831.3 Büsisee                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
        //    '10 2680515.0 1253598.8 Horenstein                +   +   +                   +   +       +   +   +   -   +   +',
        //    '11 2679925.0 1253428.8 Katzenseestrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   -   +   +',
        //    '12 2679572.5 1253371.3 Wehntalerstrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   -   +   +',
        //    '13 2679335.0 1253326.3 SBB-Nord                  +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
        //    '14 2679265.0 1253306.3 SBB-Süd                   -   -   -   -   -   -   -   -   -   -   -   -   -   -   +   -',
        //    '15 2678937.5 1253181.3 Furttalstrasse            +   +   +   +   +   +   +   +   +   +   +   +   +   -   +   +',
        //    '16 2678520.0 1252971.3 Gubrist                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +'
        //];
        //var katzenbachKombs = [
        //    '                                                 A B C D E F G H I J K L M N O P Q R S T U V W X Y',
        //    'A 2685268.0 1252747.0 Glatt                      + + + + + + + + + + + + + + + + + + + + + + + + +',
        //    'B 2685220.0 1252721.0 Glattweg                   + + + + + + + + + + + + + + + + + + + + + + + + +',
        //    'C 2684990.0 1252625.0 Orionstr.                  + + + + + + + - + + + + + + + + + + + + + + + + +',
        //    'D 2684733.0 1252531.5 Glattparkstr.              + + + + + + + - - + + + + + + - - - + + + + + + +',
        //    'E 2684681.0 1252535.5 Leutschenbachstr.          + + + + + + - - - + + + + + + - - - + + + + + + +',
        //    'F 2684464.0 1252661.5 Lilienthal                 + + + + +   - - - +   + + + + - - - -       + + +',
        //    'G 2684329.0 1252732.5 Thurgauerstr.                - - - - - - - - - - - - -   - - - - - - - -   +',
        //    'H 2684113.0 1252860.5 SBB                        - - - - - - - - - - - - - - - - - - - - - - - - -',
        //    'I 2683889.0 1252942.5 Schaffhauserstr.           - - + - - - - - - - - - - - - - - - - - - - - - -',
        //    'J 2683718.0 1253070.5 Badi                       - - + - - - - - - - - - - - - - - - - - - - - - -',
        //    'K 2683496.0 1253163.5 GZ                         - - + + +   - - - - - - - - - - - - - - - - - - -',
        //    'L 2683351.0 1253227.5 Hertensteinstr.            L - + + +   - - - - - - - - - - - - - - - - - - -',
        //    'M 2683226.0 1253342.5 Birchstr.                  + + + + + + - - - - - - - - - - - - - - - - - - -',
        //    'N 2682830.0 1253386.5 Köschenrütistr.            + + + + + + + - - - - - - - - - - - - - - - - - -',
        //    'O 2682515.0 1253362.5 Lerchenweg                 + + + + + +   - - - - - - - - - - - - - - - - - -',
        //    'P 2681983.0 1253334.5 Schwandenwisen               + + + + + - - - - - - - - - - - - - - - - - - -',
        //    'Q 2681381.0 1253271.5 Reckenholz                   + - - - - - - - - - - - - - - - - - - - - - - -',
        //    'R 2681075.0 1253610.5 Tüfwisen                     + - - - - - - - - - - - - - - - - - - - - - - -',
        //    'S 2681034.0 1253763.5 Bärenbohlstr.                + + + - - - - - - - - - - - - - - - - - - - - -',
        //    'T 2680854.0 1254006.5 Büsisee                      + + + +   - - - - - - - - - - - - - - - - - - -',
        //    'U 2680554.0 1254147.5 Rainacherweg               + + + + + + - - - - - - - - - - - - - - - - - - -',
        //    'V 2680377.0 1254226.5 Huszelgweg                 + + + + + + - - - - - - - - - - - - - - - - - - -',
        //    'W 2680219.0 1254316.5 Horensteinstr.             + + + + + + - - - - - - - - - - - - - - - - - - -',
        //    'X 2680123.0 1254328.5 Rundweg                    + + + + + +   - - - - - - - - - - - - - - - - - -',
        //    'Y 2679452.0 1254475.5 Katzensee                  + + + + + + + - - - - - - - - - - - - - - - - - -',
        //];
        ////'2020.08.24 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',
        ////'        31 xxxxxx xxxxxx FDxxxx xxxxxx xxxxxx xxxxxx F4WaNF',
        ////'     09.07 xxxxxx xxxxxx FExxxx xxxxxx xxxxxx xxxxxx aV4FMF',

        //'        14 xxxxxx xxxxxx FFxxxx xxxxxx xxxxxx xxxxxx F5VaLF',
        //'        21 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx aU5FKF',
        //'        28 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx F6TaFL FKaT6F',
        //'     10.05 aT7Axx SAxxxx xxxxxx xxxxxx RAxxxx aaQAPA GAG7Xa',
        //'        12 xxxxxx xxxxxx CGxxxx xxxxxx xxxxxx xxxxxx aX8GOG',

        //'        19 xxxxxx xxxxxx GOxxxx xxxxxx xxxxxx xxxxxx OANAMA',

        //'        26 xxxxxx xxxxxx LBxxxx xxxxxx xxxxxx xxxxxx KBKA',

        //'        19 xxxxxx xxxxxx OAxxxx xxxxxx xxxxxx xxxxxx GOG8Wa',
        //'        26 xxxxxx xxxxxx DGxxxx xxxxxx xxxxxx xxxxxx aY9GNG',
        //'     11.02 xxxxxx xxxxxx NAxxxx xxxxxx xxxxxx xxxxxx GNG29M',
        //'        09 xxxxxx xxxxxx MAxxxx xxxxxx xxxxxx xxxxxx MGL39G',
        //'        16 xxxxxx xxxxxx LAxxxx xxxxxx xxxxxx xxxxxx LBG49L',
        //'        23 xxxxxx xxxxxx EGxxxx xxxxxx xxxxxx xxxxxx SEF59S',
        //'        30 xxxxxx xxxxxx FGxxxx xxxxxx xxxxxx xxxxxx G69KKA',
        //'     12.07 xxxxxx xxxxxx KBxxxx xxxxxx xxxxxx xxxxxx KGG79J',
        //'        14 xxxxxx xxxxxx JAxxxx xxxxxx xxxxxx xxxxxx JBG89B',

        ////'        21 xxxxxx xxxxxx DGeY9G eY1HHA IAeY2I eY3JJA KAeY4K',
        ////'        28 eY5LLA GLG2Ye eY6MMG NGeY7N eY8OOG OHH3Ye H28LLB',
        ////'2021.01.04 xxxxxx xxxxxx KBxxxx xxxxxx xxxxxx xxxxxx JBI81B',
        ////'        11 xxxxxx xxxxxx HBxxxx xxxxxx xxxxxx xxxxxx HCH82D',

        ////'        21 xxxxxx xxxxxx GLL81A L82BLG GKeY2G eY8HHA IAeY3I',
        ////'        28 IDJ38D J83AKA K84BKG G48EDG EGG4Ye H5YeHN INI6Ye',
        ////'2021.01.04 xxxxxx xxxxxx IExxxx xxxxxx xxxxxx xxxxxx JEJ68B',
        ////'        11 xxxxxx xxxxxx IBxxxx xxxxxx xxxxxx xxxxxx H85BHC',
        ////'        18 xxxxxx xxxxxx CHxxxx xxxxxx xxxxxx xxxxxx H86DHE',

        ////'        21 xxxxxx xxxxxx LBK81B K82GKA HAeY2H eY9IID JDeY3J',
        ////'        28 JBJ83A I84AIB H85BHC C28HHD HNH2Ye xxxxxx xxxxxx',
        ////'2021.01.04 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',
        ////'        11 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',
        ////'        18 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',

        //'        21 xxxxxx xxxxxx I81BIA H82AHB eY2Hxx G2Yexx H3Yexx',
        //'        28 H83CCH G84CGD HDI85D J86DJE IEI8Ye eY9Ixx J7Yexx',
        //'2021.01.04 xxxxxx xxxxxx JFxxxx xxxxxx xxxxxx xxxxxx GFG88E',
        //'        11 xxxxxx xxxxxx HExxxx xxxxxx xxxxxx xxxxxx HFD28H',
        //'        18 xxxxxx xxxxxx DIxxxx xxxxxx xxxxxx xxxxxx E38IEH',
        //'        25 xxxxxx xxxxxx FHxxxx xxxxxx xxxxxx xxxxxx F48IGI',


























        // Create a background layer
        var lyr1 = ga.layer.create('ch.swisstopo.pixelkarte-farbe');
        map.addLayer(lyr1);

        var nordringKombs = [
            '                                                 1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16',
            '1  2684705.0 1253361.2 Thurgauerstrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '2  2684312.5 1253556.2 Schaffhauserstrasse       +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '3  2684115.0 1253703.7 Frohbühl                  +   +   L   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '4  2683325.0 1254116.2 Waldegg                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '5  2683080.0 1254181.2 Guldenen                  +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '6  2682790.0 1254233.7 Altwi                     +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '7  2682370.0 1254246.2 Chäshalden                +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '8  2681305.0 1253971.3 Bärenbohl                 +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '9  2681020.0 1253831.3 Büsisee                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '10 2680515.0 1253598.8 Horenstein                +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '11 2679925.0 1253428.8 Katzenseestrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '12 2679572.5 1253371.3 Wehntalerstrasse          +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '13 2679335.0 1253326.3 SBB-Nord                  +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '14 2679265.0 1253306.3 SBB-Süd                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '15 2678937.5 1253181.3 Furttalstrasse            +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +',
            '16 2678520.0 1252971.3 Gubrist                   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +   +'
        ];
        var katzenbachKombs = [
            '                                                 A B C D E F G H I J K L M N O P Q R S T U V W X Y',
            'A 2685268.0 1252747.0 Glatt                      + + + + + + + + + + + + + + + + + + + + + + + + +',
            'B 2685220.0 1252721.0 Glattweg                   + + + + + + + + + + + + + + + + + + + + + + + + +',
            'C 2684990.0 1252625.0 Orionstr.                  + + + + + + + + + + + + + + + + + + + + + + + + +',
            'D 2684733.0 1252531.5 Glattparkstr.              + + + + + + + + + + + + + + + + + + + + + + + + +',
            'E 2684681.0 1252535.5 Leutschenbachstr.          + + + + + + + + + + + + + + + + + + + + + + + + +',
            'F 2684464.0 1252661.5 Lilienthal                 + + + + + + + + + + + + + + + + + + + + + + + + +',
            'G 2684329.0 1252732.5 Thurgauerstr.              + + + + + + + + + + + + + + + + + + + + + + + + +',
            'H 2684113.0 1252860.5 SBB                        + + + + + + + + + + + + + + + + + + + + + + + + +',
            'I 2683889.0 1252942.5 Schaffhauserstr.           + + + + + + + + + + + + + + + + + + + + + + + + +',
            'J 2683718.0 1253070.5 Badi                       + + + + + + + + + + + + + + + + + + + + + + + + +',
            'K 2683496.0 1253163.5 GZ                         + + + + + + + + + + - - - - - + + + + + + + + + +',
            'L 2683351.0 1253227.5 Hertensteinstr.            + + + + + + + + + + - - - - - - + + + + + + + + +',
            'M 2683226.0 1253342.5 Birchstr.                  + + + + + + + + + + - - - - - - + + + + + + + + +',
            'N 2682830.0 1253386.5 Köschenrütistr.            + + + + + + + + + + - - - - - - + + + + + + + + +',
            'O 2682515.0 1253362.5 Lerchenweg                 + + + + + + + + + + - - - - - - + + + + + + + + +',
            'P 2681983.0 1253334.5 Schwandenwisen             + + + + + + + + + + - - - - - - + + + + + + + + +',
            'Q 2681381.0 1253271.5 Reckenholz                 + + + + + + + + + + + L - - - - + + + + + + + + +',
            'R 2681075.0 1253610.5 Tüfwisen                   + + + + + + + + + + + + + + + + + + + + + + + + +',
            'S 2681034.0 1253763.5 Bärenbohlstr.              + + + + + + + + + + + + + + + + + + + + + + + + +',
            'T 2680854.0 1254006.5 Büsisee                    + + + + + + + + + + + + + + + + + + + + + + + + +',
            'U 2680554.0 1254147.5 Rainacherweg               + + + + + + + + + + + + + + + + + + + + + + + + +',
            'V 2680377.0 1254226.5 Huszelgweg                 + + + + + + + + + + + + + + + + + + + + + + + + +',
            'W 2680219.0 1254316.5 Horensteinstr.             + + + + + + + + + + + + + + + + + + + + + + + + +',
            'X 2680123.0 1254328.5 Rundweg                    + + + + + + + + + + + + + + + + + + + + + + + + +',
            'Y 2679452.0 1254475.5 Katzensee                  + + + + + + + + + + + + + + + + + + + + + + + + +',
        ];

        var plan = [];
        var xplan = [];
        xplan = [
            '     03.07 MKxxxx MLxxxx LKxxxx LLxxxx KLxxxx KKxxxx xxxxxx',
            '        28 ONxxxx NKxxxx NLxxxx NMxxxx NNxxxx KNLNMN KMLMMM',
            '        21 PMxxxx PNxxxx POxxxx OKxxxx OLxxxx KOLOMO NOOOOM',
            '        14 QMxxxx QNxxxx QOxxxx QPxxxx PKxxxx LPMPNQ OPPPPL',
        ];
        var cmpl = [
            '     02.07 PJxxxx QJxxxx KQxxxx LQxxxx MQxxxx NQOQPQ QQQKQL',
            '        31 KIJIJJ KJxxxx JKxxxx JLxxxx LJxxxx JMJNJO MJNJOJ',
            '        24 RNxxxx ROxxxx OIxxxx NIxxxx MIxxxx IJIIIL IMINLI',
            '        17 PRxxxx ORxxxx NRxxxx MRxxxx RQxxxx LRKRRP RKRLRM',
            '        10 SLxxxx SMxxxx SNxxxx SOxxxx SPxxxx RSRJxx RRQRxx',
            '2022.01.03 LSxxxx MSxxxx NSxxxx OSxxxx SRxxxx PSQSxx SQSKxx',
            '        27 KTLTxx MTNTxx STxxxx JSxxxx JRJQxx SJxxxx SSKSxx',
            '        20 xxxxxx PTxxxx OTxxxx TIxxxx TJxxxx JUxxxx JTxxxx',
            '        13 xxxxxx RTxxxx QTxxxx xxxxxx xxxxxx QUxxxx PUxxxx',
            '     12.06 xxxxxx TTxxxx TKxxxx xxxxxx xxxxxx xxxxxx KURUxx',
            '        29 xxxxxx UUxxxx SUxxxx xxxxxx xxxxxx xxxxxx IUTUxx',
            '        22 xxxxxx TSxxxx TLxxxx xxxxxx xxxxxx LUxxxx UTxxxx',
            '        15 xxxxxx TRxxxx TMxxxx xxxxxx xxxxxx xxxxxx MUUSxx',
            '        08 xxxxxx TQxxxx TNxxxx xxxxxx xxxxxx xxxxxx NUURxx',
            '     11.01 xxxxxx TPxxxx TOxxxx xxxxxx xxxxxx xxxxxx OUUQxx',
            '        25 UMxxxx xxxxxx xxxxxx UNxxxx xxxxxx xxxxxx UOUPxx',
            '        18 xxxxxx ULxxxx UKxxxx xxxxxx xxxxxx xxxxxx UJUIxx',
            '        11 xxxxxx VMxxxx VNxxxx xxxxxx xxxxxx xxxxxx VOUVxx',
            '     10.04 xxxxxx xxxxxx RVxxxx SVxxxx xxxxxx xxxxxx VPTVxx',
            '        27 xxxxxx VRxxxx VLxxxx xxxxxx xxxxxx xxxxxx QVVQxx',
            '        20 xxxxxx VKxxxx VSxxxx xxxxxx xxxxxx xxxxxx OVPVxx',
            '        13 xxxxxx xxxxxx xxxxxx xxxxxx VIxxxx LVVJxx MVNVxx',
            '     09.06 xxxxxx VVxxxx VUxxxx xxxxxx xxxxxx IVVTxx JVKVxx',
            '        30 xxxxxx WSxxxx WRxxxx xxxxxx xxxxxx xxxxxx UWVWxx',
            '        23 xxxxxx WVxxxx WUxxxx xxxxxx xxxxxx xxxxxx WQWTxx',
            '        16 xxxxxx WMxxxx WNxxxx xxxxxx xxxxxx xxxxxx WOWPxx',
            '        09 xxxxxx xxxxxx WLxxxx xxxxxx xxxxxx SWxxxx WWTWxx',
            '     08.02 MWxxxx NWxxxx OWxxxx PWxxxx QWxxxx xxxxxx RWWKxx',
            '        26 XWxxxx IWxxxx WIxxxx xxxxxx JWxxxx KWLWxx WJxxxx',
            '        19 xxxxxx xxxxxx xxxxxx xxxxxx XSxxxx XTxxxx XUXVxx',
            '        12 XXxxxx xxxxxx XQxxxx xxxxxx xxxxxx xxxxxx XRxxxx',
            '     07.05 xxxxxx xxxxxx WXxxxx xxxxxx xxxxxx xxxxxx xxxxxx',
            '        28 xxxxxx xxxxxx VXxxxx xxxxxx xxxxxx xxxxxx XOXPxx',
            '        21 xxxxxx xxxxxx XNxxxx xxxxxx xxxxxx xxxxxx TXUXxx',
            '        14 xxxxxx xxxxxx XMxxxx xxxxxx xxxxxx xxxxxx RXSXxx',
            '     06.07 xxxxxx xxxxxx XLxxxx xxxxxx xxxxxx xxxxxx PXQXxx',
            '        31 LXxxxx MXxxxx xxxxxx XKxxxx xxxxxx xxxxxx NXOXxx',
            '        24 XIxxxx IHxxxx JHxxxx JXxxxx KXxxxx xxxxxx XJxxxx',
            '        17 HVxxxx THxxxx UHxxxx VHxxxx WHxxxx XHxxxx IXxxxx',
            '        10 WGxxxx xxxxxx xxxxxx xxxxxx VGxxxx UGxxxx HUxxxx',
            '     05.03 ITxxxx IOxxxx IKxxxx KHxxxx HTxxxx HXHHxx HWxxxx',
            '        26 P43Ixx H33Ixx HFxxxx HGxxxx GTxxxx xxxxxx TGxxxx',
            '        19 I31Fxx I21Gxx I22Sxx R32Ixx Q42Ixx xxxxxx S44Ixx',
            '        12 H35Jxx L53Hxx L54Gxx K55Gxx J45Gxx xxxxxx JEJ41F',
            '     04.05 Q64Hxx P65Hxx H66Nxx H56Mxx M52Hxx xxxxxx S51Hxx',
            '        29 N62Hxx H36Sxx O63Hxx H46Oxx OYxxxx PYxxxx QYxxxx',
            '        22 IExxxx I67Rxx R61Hxx GHxxxx G26Nxx xxxxxx N6Yexx',
            '        15 MGxxxx R75Gxx S76Gxx GJxxxx JDxxxx xxxxxx IDI77Q',
            '        08 G34Lxx P74Gxx G57Sxx GGxxxx G25Mxx xxxxxx M5Yexx',
            '     03.01 GFxxxx Q73Gxx H47Qxx HKxxxx H24Lxx xxxxxx L4Yexx',
            '        22 G23Kxx G27Rxx R71Exx HExxxx HDxxxx H37Rxx R72Fxx',
            '        15 SYxxxx xxxxxx xxxxxx xxxxxx RYxxxx J2Yexx K3Yexx',
            '        08 WYxxxx VYxxxx GVxxxx GWxxxx GUxxxx bUYexx cTYexx',
            '     02.01 FIxxxx Q88Fxx Q87Exx GExxxx GIxxxx I7Yexx aXYexx',
            '        25 FGxxxx F68Sxx S85Exx EHxxxx FHxxxx S86Fxx F78Rxx',
            '        18 GDxxxx R84Dxx E38Rxx EIxxxx EGxxxx E48Qxx F58Qxx',
            '        11 xxxxxx xxxxxx GCxxxx xxxxxx xxxxxx G28Qxx Q83Dxx',
            '2021.01.04 xxxxxx xxxxxx HCxxxx xxxxxx xxxxxx R81Cxx Q82Cxx',
            '        28 YSeYTa eYUbxx eYVcxx eYWexx fYXexx eYYgxx H8Yexx',
            '        21 xxxxxx xxxxxx YMYNxx eY5Oxx eY6Pxx eY7Qxx eY8Rxx',
            '        14 xxxxxx xxxxxx JPxxxx xxxxxx xxxxxx KPeY3K eY4Lxx',
            '     12.07 xxxxxx xxxxxx DIxxxx xxxxxx xxxxxx eY1Ixx eY2Jxx',
            '        30 xxxxxx xxxxxx DHxxxx xxxxxx xxxxxx eY9Hxx HPedIP',
            '        23 xxxxxx xxxxxx FPxxxx xxxxxx xxxxxx E49PDP DQD89R',
            '        16 xxxxxx xxxxxx HBxxxx xxxxxx xxxxxx xxxxxx GBG39P',
            '        09 xxxxxx xxxxxx IAxxxx xxxxxx xxxxxx xxxxxx HAC29H',
            '     11.02 xxxxxx xxxxxx JAxxxx xxxxxx xxxxxx xxxxxx J59BIB',
            // refactored:
            '        26 xxxxxx xxxxxx LBxxxx xxxxxx xxxxxx xxxxxx K69BKA',
            '        19 xxxxxx xxxxxx NAxxxx xxxxxx xxxxxx xxxxxx M79ALA',
            '        12 xxxxxx xxxxxx CGxxxx xxxxxx xxxxxx aY9GaX8G DGOGOA',//??
            '     10.05 aT7Axx SAxxxx xxxxxx xxxxxx RAxxxx aaQAPA GAG7Xa',//??
            '        28 xxxxxx xxxxxx FMxxxx xxxxxx xxxxxx F6TaFL FKaT6F',
            '        21 xxxxxx xxxxxx FNxxxx xxxxxx xxxxxx xxxxxx aU5FKF',
            '        14 xxxxxx xxxxxx FFxxxx xxxxxx xxxxxx xxxxxx F5VaLF',
            '     09.07 xxxxxx xxxxxx FExxxx xxxxxx xxxxxx xxxxxx aV4FMF',
            '        31 xxxxxx xxxxxx FDxxxx xxxxxx xxxxxx xxxxxx F4WaNF',
            '2020.08.24 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',
            //    '        26 xxxxxx xxxxxx OAxxxx xxxxxx xxxxxx xxxxxx GAa-9-',
            //    '        19 xxxxxx xxxxxx RAxxxx xxxxxx xxxxxx xxxxxx aaQAPA',
            //    '        12 xxxxxx xxxxxx -8-axx xxxxxx xxxxxx xxxxxx aT8ASA',
            //    '     10.05 --xxxx --xxxx xxxxxx xxxxxx --xxxx G7Xa-- aX7G--',
            //    '        28 xxxxxx xxxxxx FMxxxx xxxxxx xxxxxx F6TaFL aT6FFK',
            //    '        21 xxxxxx xxxxxx FNxxxx xxxxxx xxxxxx xxxxxx aU5FKF',
            //    '        14 xxxxxx xxxxxx FFxxxx xxxxxx xxxxxx xxxxxx F5VaLF',
            //    '     09.07 xxxxxx xxxxxx FExxxx xxxxxx xxxxxx xxxxxx aV4FMF',
            //    '        31 xxxxxx xxxxxx FDxxxx xxxxxx xxxxxx xxxxxx F4WaNF',
            //    '2020.08.24 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',

            //    '        26 xxxxxx xxxxxx OAxxxx xxxxxx xxxxxx xxxxxx GAaT9G',
            //    '        19 xxxxxx xxxxxx RAxxxx xxxxxx xxxxxx xxxxxx aaQAPA',
            //    '        12 xxxxxx xxxxxx G8Taxx xxxxxx xxxxxx xxxxxx aT8ASA',
            //    '     10.05 SFxxxx SExxxx xxxxxx xxxxxx SGxxxx G7XaGB aX7GGC',
            //    '        28 xxxxxx xxxxxx FMxxxx xxxxxx xxxxxx F6TaFL aT6FFK',
            //    '        21 xxxxxx xxxxxx FNxxxx xxxxxx xxxxxx xxxxxx aU5FKF',
            //    '        14 xxxxxx xxxxxx FFxxxx xxxxxx xxxxxx xxxxxx F5VaLF',
            //    '     09.07 xxxxxx xxxxxx FExxxx xxxxxx xxxxxx xxxxxx aV4FMF',
            //    '        31 xxxxxx xxxxxx FDxxxx xxxxxx xxxxxx xxxxxx F4WaNF',
            //    '2020.08.24 xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx xxxxxx',

        ];
        xplan = [
            '        08 xxxxxx xxxxxx GDxxxx xxxxxx xxxxxx xxxxxx Q87GGN',
            '     02.01 xxxxxx xxxxxx HCxxxx xxxxxx xxxxxx xxxxxx H78SHD',
            '        25 xxxxxx xxxxxx FGxxxx xxxxxx xxxxxx xxxxxx S88FFH',
            '        18 xxxxxx xxxxxx FIxxxx xxxxxx xxxxxx xxxxxx R86FQF',
            '        11 xxxxxx xxxxxx EGxxxx xxxxxx xxxxxx xxxxxx R85EEI',
            '2021.01.04 xxxxxx xxxxxx GKxxxx xxxxxx xxxxxx xxxxxx G68SSE',
            '        28 GJP81G GQF38Q F48SFR G58RHR H8Yexx I2Yexx eY6Kxx',
            '        21 xxxxxx xxxxxx E28REQ Q84EEH eY8Hxx eY9Ixx eY1Jxx',
            '        14 xxxxxx xxxxxx GCxxxx xxxxxx xxxxxx xxxxxx R83CRD',
            '     12.07 xxxxxx xxxxxx DIxxxx xxxxxx xxxxxx xxxxxx Q82DQC',
            '        30 xxxxxx xxxxxx DHxxxx xxxxxx xxxxxx xxxxxx DQD89R',
            '        23 xxxxxx xxxxxx FPxxxx xxxxxx xxxxxx xxxxxx E49PDP',
            //'        16 xxxxxx xxxxxx HBxxxx xxxxxx xxxxxx xxxxxx GBG39P',
            //'        09 xxxxxx xxxxxx IAxxxx xxxxxx xxxxxx xxxxxx HAC29H',
            //'     11.02 xxxxxx xxxxxx JAxxxx xxxxxx xxxxxx xxxxxx J59BIB',

        ];
        xplan = [
            '     03.01 xxxxxx xxxxxx HDxxxx xxxxxx xxxxxx xxxxxx H8Yexx',
            '        22 xxxxxx xxxxxx GGxxxx xxxxxx xxxxxx xxxxxx GRR85D',
            '        15 xxxxxx xxxxxx HCxxxx xxxxxx xxxxxx xxxxxx H58QGQ',
            '        08 xxxxxx xxxxxx FHxxxx xxxxxx xxxxxx xxxxxx R84FRC',
            '     02.01 xxxxxx xxxxxx EHxxxx xxxxxx xxxxxx xxxxxx E48RFR',
            '        25 xxxxxx xxxxxx GFxxxx xxxxxx xxxxxx xxxxxx F38QEQ',
            '        18 xxxxxx xxxxxx GDxxxx xxxxxx xxxxxx xxxxxx Q83GQF',
            '        11 xxxxxx xxxxxx GCxxxx xxxxxx xxxxxx xxxxxx Q82CQD',
            '2021.01.04 xxxxxx xxxxxx EGxxxx xxxxxx xxxxxx xxxxxx Q81EGE',
            '        28 eY4Nxx eY5Oxx eY6Pxx eY7Qxx eY8Rxx YSxxxx F28SFG',
            '        21 xxxxxx xxxxxx YIxxxx YJxxxx eY1Kxx eY2Lxx eY3Mxx',
            '        14 xxxxxx xxxxxx HPxxxx xxxxxx xxxxxx xxxxxx IPedxx',
            '     12.07 xxxxxx xxxxxx DHxxxx xxxxxx xxxxxx xxxxxx eY9Hxx',
            '        30 xxxxxx xxxxxx DIxxxx xxxxxx xxxxxx xxxxxx DQD89R',
            '        23 xxxxxx xxxxxx FPxxxx xxxxxx xxxxxx xxxxxx E49PDP',
            //'        16 xxxxxx xxxxxx HBxxxx xxxxxx xxxxxx xxxxxx GBG39P',
            //'        09 xxxxxx xxxxxx IAxxxx xxxxxx xxxxxx xxxxxx HAC29H',
            //'     11.02 xxxxxx xxxxxx JAxxxx xxxxxx xxxxxx xxxxxx J59BIB',
        ];

        //var arrayBufferView = new Uint8Array(this.response);
        //var blob = new Blob([arrayBufferView], { type: "image/bmp" });
        //var urlCreator = window.URL || window.webkitURL;
        //var imageUrl = urlCreator.createObjectURL(blob);
        //var img = document.getElementById("idCompletedImg");
        //img.src = imageUrl;

        // Karte und Liste zusammenstellen
        var nordringLyr = createLayer(nordringKombs);
        addPlan(nordringLyr, plan); CalcCompleted(nordringLyr);
        nordringLyr.set('title', 'Nordring'); map.addLayer(nordringLyr);

        var katzenbachLyr = createLayer(katzenbachKombs);
        addPlan(katzenbachLyr, plan); CalcCompleted(katzenbachLyr);
        katzenbachLyr.set('title', 'Katzenbach'); map.addLayer(katzenbachLyr);

        document.getElementById("idImgNordring").src = getImgFromLyr(nordringLyr); // getImgSrc(b, 1, 16, 16);
        document.getElementById("idImgKatzenbach").src = getImgFromLyr(katzenbachLyr); // getImgSrc(b, 1, 25, 25);

        var dspLyr = new ol.layer.Vector({ visible: false, style: dspStyle, source: new ol.source.Vector({ features: [] }) });
        map.addLayer(dspLyr);

        var connLyr = new ol.layer.Vector({ visible: false, style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: [255, 0, 0, 1], width: 4 }) }), source: new ol.source.Vector({ features: [] }) });
        map.addLayer(connLyr);

        map.on('pointermove', showInfo);
        map.on('click', displayFeature);

        var info = document.getElementById('idInfo');
        var targetLyr = null;
        var targetFeature = null;
        var infoLyrs = [katzenbachLyr, nordringLyr];

        function showInfo(event) {
            infoLyr = null;
            targetFeature = null;
            dspLyr.setVisible(false);
            for (var iLyr = 0; iLyr < infoLyrs.length; iLyr++) {
                var lyr = infoLyrs[iLyr];
                lyr.setVisible(true);
            }

            for (var iLyr = 0; iLyr < infoLyrs.length; iLyr++) {
                var lyr = infoLyrs[iLyr];
                var featuresAt = map.getFeaturesAtPixel(event.pixel, {
                    layerFilter: function (cand) {
                        return cand == lyr;
                    }
                });
                if (featuresAt == null || featuresAt.length == 0) {
                    info.innerText = '';
                    info.style.opacity = 0;
                    highlightKarte = '';
                } else {
                    var nPoints = lyr.getSource().getFeatures().length;
                    var f = featuresAt[0];
                    var k = f.get('key');
                    var text = '';
                    var starts = f.get('starts');
                    var ends = f.get('ends');
                    text = text + lyr.get('title') + ': ' + lyr.get('completed').toString() + ' von total ' + lyr.get('total').toString() + '\n';
                    text = text + 'von ' + k + ' nach: ' + starts.toString() + '  ( ' + starts.length.toString() + ' von ' + nPoints.toString() + ' )' + '\n';
                    text = text + 'nach ' + k + ' von: ' + ends.toString() + '  ( ' + ends.length.toString() + ' von ' + nPoints.toString() + ' )' + '\n';
                    text = text + '(Klicken zum anzeigen)';

                    info.innerText = text;
                    info.style.opacity = 1;

                    targetFeature = f;
                    targetLyr = lyr;
                    return;
                }
            }
        }

        function showComb(lyr, start, end) {
            var connSource = connLyr.getSource();
            connSource.clear({ fast: true });
            var connFeatures = [];

            var fs = lyr.getSource().getFeatures();
            var nPoints = fs.length;
            var pStart = null;
            var pEnd = null;
            for (iPoint = 0; iPoint < nPoints; iPoint++) {
                var f = fs[iPoint];
                var k = f.get('key');
                if (k == start) {
                    pStart = f.getGeometry().clone();
                }
                if (k == end) {
                    pEnd = f.getGeometry().clone();
                }
            }

            var connFeature = new ol.Feature({
                geometry: new ol.geom.LineString([[2683278.0, 1252955.0], pStart.getFirstCoordinate(), pEnd.getFirstCoordinate()])
            });
            connFeatures.push(connFeature);

            connSource.addFeatures(connFeatures);
            connLyr.setVisible(true);
        }
        async function replayCombs(lyr, imgId, cmpl) {
            var startDict = {};
            var endDict = {};
            var isNumeric = fillDict(lyr, startDict, endDict);
            var combs = getCombs(cmpl, isNumeric);


            var invalid = "";
            var nCombs = combs.length;

            for (iComb = 0; iComb < nCombs; iComb++) {
                var comb = combs[iComb];
                var s = comb[0];
                var e = comb[1];
                var sd = startDict[s];
                var iS = sd.indexOf(e.toString());
                if (iS >= 0) {
                    sd.splice(iS, 1);
                } else {
                    invalid += s + "->" + e + ";";
                }

                var ed = endDict[e];
                var iE = ed.indexOf(s.toString());
                if (iE >= 0) {
                    ed.splice(iE, 1);
                }
            }
            if (invalid.length > 0) {
                alert("invalid: " + invalid);
            }

            CalcCompleted(lyr);
            document.getElementById(imgId).src = getImgFromLyr(lyr);
            var src = lyr.getSource();
            lyr.setSource(null);
            lyr.setSource(src);

            for (iComb = 0; iComb < nCombs; iComb++) {
                await sleep(500);

                var comb = combs[iComb];
                var s = comb[0];
                var e = comb[1];
                var sd = startDict[s];
                sd.push(e.toString());

                var ed = endDict[e];
                ed.push(s.toString());
                CalcCompleted(lyr);
                document.getElementById(imgId).src = getImgFromLyr(lyr);
                var src = lyr.getSource();
                lyr.setSource(null);
                lyr.setSource(src);
                showComb(lyr, s.toString(), e.toString());
            }
            await sleep(500);
            connLyr.setVisible(false);
        }
        async function replay() {
            await replayCombs(nordringLyr, "idImgNordring", cmpl);

            await replayCombs(katzenbachLyr, "idImgKatzenbach", cmpl);
        }
        function displayFeature(event) {
            if (targetLyr == null || targetFeature == null) {
                return;
            }
            for (var iLyr = 0; iLyr < infoLyrs.length; iLyr++) {
                var lyr = infoLyrs[iLyr];
                lyr.setVisible(false);
            }

            var targetKey = targetFeature.get('key');
            var starts = targetFeature.get('starts');
            var ends = targetFeature.get('ends');

            var infoFeatures = targetLyr.getSource().getFeatures();
            var dspSource = dspLyr.getSource();
            dspSource.clear({ fast: true });
            var dspFeatures = [];
            var iFeature = 0;
            for (iFeature = 0; iFeature < infoFeatures.length; iFeature++) {
                var infoFeature = infoFeatures[iFeature];
                var key = infoFeature.get('key');
                var title = infoFeature.get('title');
                var startsAtKey = starts.includes(key);
                var endsAtKey = ends.includes(key);
                var isTarget = (key == targetKey);

                var dspFeature = new ol.Feature({
                    geometry: infoFeature.getGeometry().clone(),
                    key: key,
                    title: title,
                    startsAtKey: startsAtKey,
                    endsAtKey: endsAtKey,
                    isTarget: isTarget
                });
                dspFeatures.push(dspFeature);
            }
            dspSource.addFeatures(dspFeatures);
            dspLyr.setVisible(true);
        }

        function dspStyle(feature, resolution) {
            var fStart = feature.get('startsAtKey') ? 1 : 0;
            var fEnd = feature.get('endsAtKey') ? 1 : 0;
            var isTarget = feature.get('isTarget') ? 1 : 0;

            var style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    stroke: new ol.style.Stroke({
                        color: getColor(fStart),
                        width: isTarget ? 0 : 5
                    }),
                    fill: new ol.style.Fill({ color: getColor(fEnd) }),
                }),
                text: textStyle
            });
            style.getText().setText(feature.get('key'));
            return style;
        }

        function getColor(f) {
            //var fr = Math.min(2 - 2.0 * f, 1);
            //var fg = Math.min(2.0 * f, 1);
            //return [fr * 255, fg * 255, 0, 1];

            var fr = Math.max(Math.min(2 - 4.0 * f, 1), 0);
            var fg = Math.min(4.0 * f, 4 - 4.0 * f, 1);
            var fb = Math.max(Math.min(-2 + 4.0 * f, 1), 0);
            return [fr * 255, fg * 255, fb * 255, 1];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        window.onresize = function () {
            setTimeout(function () { map.updateSize(); }, 200);
        }

    </script>

</body>
</html>
